- name: enable secrets engine PKI
  hashivault_secret_engine:
    name: pki
    backend: pki
  environment: "{{ environment }}"
  register: pki_engine

- name: get PKI certificate
  hashivault_pki_cert_get:
  register: old_pki_cert
  environment: "{{ environment }}"

- name: read new PKI certificate
  set_fact:
    new_pki_cert:  "{{ lookup('file', caBundleLocation) }}"


# if the existing certificate is an empty dictionary or a certificate string which is the prefix of the local
# certificate + private key bundle.
- name: import root certificate
  hashivault_pki_ca_set:
    pem_bundle: "{{ new_pki_cert }}"
  environment: "{{ environment }}"
  when: (not 'certificate' in old_pki_cert.data) or (not new_pki_cert.startswith(old_pki_cert.data.certificate))